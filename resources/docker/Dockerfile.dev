# Development Dockerfile with hot reload
FROM golang:1.25.3-alpine

WORKDIR /app

# Install dependencies and reflex for hot reload
RUN apk add --no-cache git make
RUN go install github.com/cespare/reflex@latest

# Copy go mod files
COPY api/go.mod api/go.sum ./
RUN go mod download

# Install oapi-codegen
RUN go install github.com/deepmap/oapi-codegen/cmd/oapi-codegen@latest

# Copy source code
COPY api/ ./
COPY resources/ /app/resources/

# Generate OpenAPI code
RUN mkdir -p gen
RUN oapi-codegen -package gen -generate types,server,spec /app/resources/openapi/openapi.yaml > gen/openapi.gen.go

# Expose port
EXPOSE 8080

# Use reflex for hot reload with OpenAPI code generation
CMD sh -c "mkdir -p gen && oapi-codegen -package gen -generate types,server,spec /app/resources/openapi/openapi.yaml > gen/openapi.gen.go && reflex -r '\\.go$' -s -- go run ./cmd/main.go"
